version: 2

jobs:
  Bump Git Tag:
    docker:
      - image: gcr.io/rxjs-fiddle/ci/gitversion:0.0.8
        auth:
          username: _json_key
          password: ${GCLOUD_SERVICE_KEY}

    steps:
      - add_ssh_keys:
          fingerprints:
            - "be:36:c9:3d:00:7e:38:2e:f9:90:10:99:3d:86:64:1c"
      - checkout
      - run: gitversion bump auto
      - run: git push origin --tags

  Build All Images:
    docker:
      - image: docker:latest

    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run: docker build -t gcr.io/rxjs-fiddle/ci/gcloud -f Dockerfile.gcloud .
      - run: docker build -t gcr.io/rxjs-fiddle/ci/giversion -f Dockerfile.gitversion .

  Build And Push All Images:
    docker:
      - image: docker:latest

    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run: echo "${GCLOUD_SERVICE_KEY}" | docker login -u _json_key --password-stdin https://gcr.io
      - run: docker build -t gcr.io/rxjs-fiddle/ci/gcloud:${CIRCLE_TAG} -f Dockerfile.gcloud .
      - run: docker build -t gcr.io/rxjs-fiddle/ci/gitversion:${CIRCLE_TAG} -f Dockerfile.gitversion .
      - run: docker push gcr.io/rxjs-fiddle/ci/gcloud:${CIRCLE_TAG}
      - run: docker push gcr.io/rxjs-fiddle/ci/gitversion:${CIRCLE_TAG}

workflows:
  version: 2

  Tag Commits to Master:
    jobs:
      - Bump Git Tag:
          filters:
            branches:
              only: master

  Build Images for PR Branches:
    jobs:
      - Build All Images:
          filters:
            branches:
              ignore: master

  Push Images for Tags:
    jobs:
      - Build And Push All Images:
          filters:
            tags:
              only: /.*/
            branches:
              ignore: /.*/
